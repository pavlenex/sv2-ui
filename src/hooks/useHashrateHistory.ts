import { useEffect, useRef, useState } from 'react';

export interface HashrateDataPoint {
  time: string;
  timestamp: number;
  hashrate: number;
}

const MAX_HISTORY_POINTS = 60; // Keep last 60 data points
const SAMPLE_INTERVAL_MS = 5000; // Sample every 5 seconds

/**
 * Hook to accumulate hashrate history from real-time data.
 * Since the API doesn't provide historical data, we build it client-side.
 * 
 * @param currentHashrate - The current hashrate value to track
 * @returns Array of historical data points
 */
export function useHashrateHistory(currentHashrate: number | undefined): HashrateDataPoint[] {
  const [history, setHistory] = useState<HashrateDataPoint[]>([]);
  const hashrateRef = useRef<number | undefined>(currentHashrate);

  // Keep ref in sync with latest value without triggering the interval effect
  useEffect(() => {
    hashrateRef.current = currentHashrate;
  }, [currentHashrate]);

  // Sample on a fixed interval regardless of whether the value changed.
  // Previously this used useEffect([currentHashrate]) which only fired on
  // value changes â€” meaning a constant hashrate (including 0) would never
  // accumulate more than one data point and the chart would stay blank.
  useEffect(() => {
    function sample() {
      const value = hashrateRef.current;
      if (value === undefined || value === null) return;

      const now = Date.now();
      const timeStr = new Date(now).toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: false,
      });

      setHistory(prev => {
        const newPoint: HashrateDataPoint = { time: timeStr, timestamp: now, hashrate: value };
        const updated = [...prev, newPoint];
        return updated.length > MAX_HISTORY_POINTS ? updated.slice(-MAX_HISTORY_POINTS) : updated;
      });
    }

    sample(); // Capture initial value immediately
    const id = setInterval(sample, SAMPLE_INTERVAL_MS);
    return () => clearInterval(id);
  }, []); // Run once on mount

  return history;
}

/**
 * Hook to accumulate share submission history.
 * Tracks accepted and submitted shares over time.
 */
export interface ShareDataPoint {
  time: string;
  timestamp: number;
  accepted: number;
  submitted: number;
}

export function useShareHistory(
  accepted: number | undefined, 
  submitted: number | undefined
): ShareDataPoint[] {
  const [history, setHistory] = useState<ShareDataPoint[]>([]);
  const lastSampleTime = useRef<number>(0);
  const lastAccepted = useRef<number>(0);
  const lastSubmitted = useRef<number>(0);

  useEffect(() => {
    if (accepted === undefined || submitted === undefined) return;

    const now = Date.now();
    
    // Only add a new sample if enough time has passed
    if (now - lastSampleTime.current < SAMPLE_INTERVAL_MS) return;
    
    lastSampleTime.current = now;
    
    const timeStr = new Date(now).toLocaleTimeString('en-US', {
      hour: '2-digit',
      minute: '2-digit',
      hour12: false,
    });

    // Calculate delta (new shares since last sample)
    const deltaAccepted = Math.max(0, accepted - lastAccepted.current);
    const deltaSubmitted = Math.max(0, submitted - lastSubmitted.current);
    
    lastAccepted.current = accepted;
    lastSubmitted.current = submitted;

    // Only record if there's actual activity (skip initial zero delta)
    if (history.length > 0 || deltaSubmitted > 0) {
      setHistory(prev => {
        const newPoint: ShareDataPoint = {
          time: timeStr,
          timestamp: now,
          accepted: deltaAccepted,
          submitted: deltaSubmitted,
        };
        
        const updated = [...prev, newPoint];
        
        if (updated.length > MAX_HISTORY_POINTS) {
          return updated.slice(-MAX_HISTORY_POINTS);
        }
        
        return updated;
      });
    }
  }, [accepted, submitted, history.length]);

  return history;
}
